(function(e){"function"===typeof define&&define.amd?define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],e):e(window.jQuery,window.loadImage)})(function(e,g){e.widget("blueimpFP.fileupload",e.blueimp.fileupload,{options:{process:[],add:function(a,d){e(this).fileupload("process",d).done(function(){d.submit()})}},processActions:{load:function(a,d){var c=this,b=a.files[a.index],f=e.Deferred();window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&("number"!==e.type(d.maxFileSize)||
b.size<d.maxFileSize)&&(!d.fileTypes||d.fileTypes.test(b.type))?g(b,function(b){a.canvas=b;f.resolveWith(c,[a])},{canvas:!0}):f.rejectWith(c,[a]);return f.promise()},resize:function(a,d){if(a.canvas){var c=g.scale(a.canvas,d);if(c.width!==a.canvas.width||c.height!==a.canvas.height)a.canvas=c,a.processed=!0}return a},save:function(a){if(!a.canvas||!a.processed)return a;var d=this,c=a.files[a.index],b=c.name,f=e.Deferred(),h=function(b){b.name||(c.type===b.type?b.name=c.name:c.name&&(b.name=c.name.replace(/\..+$/,
"."+b.type.substr(6))));a.files[a.index]=b;f.resolveWith(d,[a])};a.canvas.mozGetAsFile?h(a.canvas.mozGetAsFile(/^image\/(jpeg|png)$/.test(c.type)&&b||(b&&b.replace(/\..+$/,"")||"blob")+".png",c.type)):a.canvas.toBlob(h,c.type);return f.promise()}},_processFile:function(a,d,c){var b=this,f=e.Deferred().resolveWith(b,[{files:a,index:d}]).promise();b._processing+=1;e.each(c.process,function(a,c){f=f.pipe(function(a){return b.processActions[c.action].call(this,a,c)})});f.always(function(){b._processing-=
1;0===b._processing&&b.element.removeClass("fileupload-processing")});1===b._processing&&b.element.addClass("fileupload-processing");return f},process:function(a){var d=this,c=e.extend({},this.options,a);c.process&&(c.process.length&&this._isXHRUpload(c))&&e.each(a.files,function(b){d._processingQueue=d._processingQueue.pipe(function(){var f=e.Deferred();d._processFile(a.files,b,c).always(function(){f.resolveWith(d)});return f.promise()})});return this._processingQueue},_create:function(){e.blueimp.fileupload.prototype._create.call(this);
this._processing=0;this._processingQueue=e.Deferred().resolveWith(this).promise()}})});