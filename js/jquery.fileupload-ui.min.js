(function(d){"function"===typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],d):d(window.jQuery,window.tmpl,window.loadImage)})(function(d,i,j){var g=(d.blueimpFP||d.blueimp).fileupload;d.widget("blueimpUI.fileupload",g,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5E6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,
uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(a,b){var c=d(this).data("fileupload"),e=c.options,f=b.files;d(this).fileupload("process",b).done(function(){c._adjustMaxNumberOfFiles(-f.length);b.maxNumberOfFilesAdjusted=!0;b.files.valid=b.isValidated=c._validate(f);b.context=c._renderUpload(f).data("data",b);e.filesContainer[e.prependFiles?"prepend":"append"](b.context);c._renderPreviews(f,b.context);c._forceReflow(b.context);
c._transition(b.context).done(function(){!1!==c._trigger("added",a,b)&&((e.autoUpload||b.autoUpload)&&!1!==b.autoUpload&&b.isValidated)&&b.submit()})})},send:function(a,b){var c=d(this).data("fileupload");if(!b.isValidated&&(b.maxNumberOfFilesAdjusted||(c._adjustMaxNumberOfFiles(-b.files.length),b.maxNumberOfFilesAdjusted=!0),!c._validate(b.files)))return!1;b.context&&(b.dataType&&"iframe"===b.dataType.substr(0,6))&&b.context.find(".progress").addClass(!d.support.transition&&"progress-animated").attr("aria-valuenow",
100).find(".bar").css("width","100%");return c._trigger("sent",a,b)},done:function(a,b){var c=d(this).data("fileupload"),e;b.context?b.context.each(function(f){var h=d.isArray(b.result)&&b.result[f]||{error:"emptyResult"};h.error&&c._adjustMaxNumberOfFiles(1);c._transition(d(this)).done(function(){var f=d(this);e=c._renderDownload([h]).replaceAll(f);c._forceReflow(e);c._transition(e).done(function(){b.context=d(this);c._trigger("completed",a,b)})})}):(d.isArray(b.result)&&(d.each(b.result,function(a,
d){b.maxNumberOfFilesAdjusted&&d.error?c._adjustMaxNumberOfFiles(1):!b.maxNumberOfFilesAdjusted&&!d.error&&c._adjustMaxNumberOfFiles(-1)}),b.maxNumberOfFilesAdjusted=!0),e=c._renderDownload(b.result).appendTo(c.options.filesContainer),c._forceReflow(e),c._transition(e).done(function(){b.context=d(this);c._trigger("completed",a,b)}))},fail:function(a,b){var c=d(this).data("fileupload"),e;b.maxNumberOfFilesAdjusted&&c._adjustMaxNumberOfFiles(b.files.length);b.context?b.context.each(function(f){if("abort"!==
b.errorThrown){var h=b.files[f];h.error=h.error||b.errorThrown||!0;c._transition(d(this)).done(function(){var f=d(this);e=c._renderDownload([h]).replaceAll(f);c._forceReflow(e);c._transition(e).done(function(){b.context=d(this);c._trigger("failed",a,b)})})}else c._transition(d(this)).done(function(){d(this).remove();c._trigger("failed",a,b)})}):"abort"!==b.errorThrown?(b.context=c._renderUpload(b.files).appendTo(c.options.filesContainer).data("data",b),c._forceReflow(b.context),c._transition(b.context).done(function(){b.context=
d(this);c._trigger("failed",a,b)})):c._trigger("failed",a,b)},progress:function(a,b){if(b.context){var c=parseInt(100*(b.loaded/b.total),10);b.context.find(".progress").attr("aria-valuenow",c).find(".bar").css("width",c+"%")}},progressall:function(a,b){var c=d(this),e=parseInt(100*(b.loaded/b.total),10),f=c.find(".fileupload-progress"),h=f.find(".progress-extended");h.length&&h.html(c.data("fileupload")._renderExtendedProgress(b));f.find(".progress").attr("aria-valuenow",e).find(".bar").css("width",
e+"%")},start:function(a){var b=d(this).data("fileupload");b._transition(d(this).find(".fileupload-progress")).done(function(){b._trigger("started",a)})},stop:function(a){var b=d(this).data("fileupload");b._transition(d(this).find(".fileupload-progress")).done(function(){d(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");d(this).find(".progress-extended").html("&nbsp;");b._trigger("stopped",a)})},destroy:function(a,b){var c=d(this).data("fileupload");b.url&&(d.ajax(b),
c._adjustMaxNumberOfFiles(1));c._transition(b.context).done(function(){d(this).remove();c._trigger("destroyed",a,b)})}},_enableDragToDesktop:function(){var a=d(this),b=a.prop("href"),c=a.prop("download");a.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",c,b].join(":"))}catch(d){}})},_adjustMaxNumberOfFiles:function(a){"number"===typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=a,1>this.options.maxNumberOfFiles?this._disableFileInputButton():
this._enableFileInputButton())},_formatFileSize:function(a){return"number"!==typeof a?"":1E9<=a?(a/1E9).toFixed(2)+" GB":1E6<=a?(a/1E6).toFixed(2)+" MB":(a/1E3).toFixed(2)+" KB"},_formatBitrate:function(a){return"number"!==typeof a?"":1E9<=a?(a/1E9).toFixed(2)+" Gbit/s":1E6<=a?(a/1E6).toFixed(2)+" Mbit/s":1E3<=a?(a/1E3).toFixed(2)+" kbit/s":a+" bit/s"},_formatTime:function(a){var b=new Date(1E3*a),a=parseInt(a/86400,10);return(a?a+"d ":"")+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+
":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(100*a).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime(8*(a.total-a.loaded)/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_hasError:function(a){return a.error?a.error:0>this.options.maxNumberOfFiles?"maxNumberOfFiles":!this.options.acceptFileTypes.test(a.type)&&!this.options.acceptFileTypes.test(a.name)?
"acceptFileTypes":this.options.maxFileSize&&a.size>this.options.maxFileSize?"maxFileSize":"number"===typeof a.size&&a.size<this.options.minFileSize?"minFileSize":null},_validate:function(a){var b=this,c=!!a.length;d.each(a,function(a,d){d.error=b._hasError(d);d.error&&(c=!1)});return c},_renderTemplate:function(a,b){if(!a)return d();var c=a({files:b,formatFileSize:this._formatFileSize,options:this.options});return c instanceof d?c:d(this.options.templatesContainer).html(c).children()},_renderPreview:function(a,
b){var c=this,e=this.options,f=d.Deferred();return(j&&j(a,function(a){b.append(a);c._forceReflow(b);c._transition(b).done(function(){f.resolveWith(b)});d.contains(document.body,b[0])||f.resolveWith(b)},{maxWidth:e.previewMaxWidth,maxHeight:e.previewMaxHeight,canvas:e.previewAsCanvas})||f.resolveWith(b))&&f},_renderPreviews:function(a,b){var c=this,e=this.options;b.find(".preview span").each(function(b,h){var g=a[b];if(e.previewSourceFileTypes.test(g.type)&&("number"!==d.type(e.previewSourceMaxFileSize)||
g.size<e.previewSourceMaxFileSize))c._processingQueue=c._processingQueue.pipe(function(){var a=d.Deferred();c._renderPreview(g,d(h)).done(function(){a.resolveWith(c)});return a.promise()})});return this._processingQueue},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(a){return this._renderTemplate(this.options.downloadTemplate,a).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(a){a.preventDefault();var a=
d(this),b=a.closest(".template-upload").data("data");b&&(b.submit&&!b.jqXHR&&b.submit())&&a.prop("disabled",!0)},_cancelHandler:function(a){a.preventDefault();var b=d(this).closest(".template-upload").data("data")||{};b.jqXHR?b.jqXHR.abort():(b.errorThrown="abort",a.data.fileupload._trigger("fail",a,b))},_deleteHandler:function(a){a.preventDefault();var b=d(this);a.data.fileupload._trigger("destroy",a,{context:b.closest(".template-download"),url:b.attr("data-url"),type:b.attr("data-type")||"DELETE",
dataType:a.data.fileupload.options.dataType})},_forceReflow:function(a){return d.support.transition&&a.length&&a[0].offsetWidth},_transition:function(a){var b=d.Deferred();d.support.transition&&a.hasClass("fade")?a.bind(d.support.transition.end,function(c){c.target===a[0]&&(a.unbind(d.support.transition.end),b.resolveWith(a))}).toggleClass("in"):(a.toggleClass("in"),b.resolveWith(a));return b},_initButtonBarEventHandlers:function(){var a=this.element.find(".fileupload-buttonbar"),b=this.options.filesContainer,
c=this.options.namespace;a.find(".start").bind("click."+c,function(a){a.preventDefault();b.find(".start button").click()});a.find(".cancel").bind("click."+c,function(a){a.preventDefault();b.find(".cancel button").click()});a.find(".delete").bind("click."+c,function(c){c.preventDefault();b.find(".delete input:checked").siblings("button").click();a.find(".toggle").prop("checked",!1)});a.find(".toggle").bind("change."+c,function(){b.find(".delete input").prop("checked",d(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+
this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){g.prototype._initEventHandlers.call(this);var a={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,a,this._startHandler).delegate(".cancel button","click."+this.options.namespace,a,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,a,this._deleteHandler);this._initButtonBarEventHandlers()},
_destroyEventHandlers:function(){var a=this.options;this._destroyButtonBarEventHandlers();a.filesContainer.undelegate(".start button","click."+a.namespace).undelegate(".cancel button","click."+a.namespace).undelegate(".delete button","click."+a.namespace);g.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",
!0).parent().addClass("disabled")},_initTemplates:function(){var a=this.options;a.templatesContainer=document.createElement(a.filesContainer.prop("nodeName"));if(i&&(a.uploadTemplateId&&(a.uploadTemplate=i(a.uploadTemplateId)),a.downloadTemplateId))a.downloadTemplate=i(a.downloadTemplateId)},_initFilesContainer:function(){var a=this.options;void 0===a.filesContainer?a.filesContainer=this.element.find(".files"):a.filesContainer instanceof d||(a.filesContainer=d(a.filesContainer))},_stringToRegExp:function(a){var a=
a.split("/"),b=a.pop();a.shift();return RegExp(a.join("/"),b)},_initRegExpOptions:function(){var a=this.options;"string"===d.type(a.acceptFileTypes)&&(a.acceptFileTypes=this._stringToRegExp(a.acceptFileTypes));"string"===d.type(a.previewSourceFileTypes)&&(a.previewSourceFileTypes=this._stringToRegExp(a.previewSourceFileTypes))},_initSpecialOptions:function(){g.prototype._initSpecialOptions.call(this);this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_create:function(){g.prototype._create.call(this);
this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");d.blueimpFP||(this._processingQueue=d.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue})},enable:function(){g.prototype.enable.call(this);this.element.find("input, button").prop("disabled",!1);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",!0);this._disableFileInputButton();g.prototype.disable.call(this)}})});